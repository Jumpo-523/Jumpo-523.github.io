
## なんの記事なのか？
仕事していく中で目についたsed, awkの使用例を１個１個理解しながら記録していくメモ記事です。


<a href="#case_one">**yamlファイルからenv変数作成shを作成する**</a>

## sedについて

### sedの仕様
まず、sedはファイルの中身を走査し、パターンに合う文字列を見つけたら、入れ替える処理を行ってくれるコマンドです。

【使用方法】
- **`sed -e 's/{{pattern}}/{{repl}}/g;' file_name`と言うコマンドで、file_nameのテキストに`{{pattern}}`があったら`{{repl}}`に入れ替える処理を実行します。**

【ルール】
- `;`で区切られた部分が1パターンになります。
- `s/`と`/g`は始まりと~~終わり~~を示す仕様です。（言葉選ぶ）
    - (1029修正)**最後の g はすべてのマッチした文字列を置換することを意味する。 g がなくても全行で置換を実行するが、1行に2つ以上マッチした場合は 1つ目しか置換されない。[(link)](https://hydrocul.github.io/wiki/commands/sed.html)**
    - gはglobal のgですね。

## awkについて

```
AWK はフィルタリングによく使用されるコマンドであるが、同様にしてフィルタリングに使用される grep や cut と決定的に違うところは、AWK 自体が独立した一つのスクリプト言語であるということだ
```
[参照記事](https://shellscript.sunone.me/awk.html)

AWK 自体が独立した一つのスクリプト言語であると言う点が、にわかエンジニアの人にとってとっつきづらいところになると思います。


詳しくは、後日追記していきます。

### AWKスクリプト組み込み変数
- NR: 現在読み込んでいる行の行番号
- $N: Nフィールド目の内容が設定されている





<div id="case_one"></div>

####  利用ケース①：yaml fileをparseして環境変数に入れたい時、

では実際に使用例を見てみます。今、

```yaml[file.yaml]
VAR1: XXXXXXXXXX
```
と言うyaml fileがあったときに、

```
VAR1="XXXXXXXXXX"
```
と言う風に変換したいとします。
この場合、sedを用いてfileの中身を変換することができます。

```sh
sed -e 's/:[^:\/\/]/="/g;s/$/"/g;s/ *=/=/g' file.yaml > file.sh
```

上記の処理を1から見ていきましょう。


- 上記の例の１個目のパターンは、
    - `{{pattern}}`が `:[^:\/\/]`
    - `="`が`{{repl}}`に該当します。


ですので、`:`を見つけたら（注：`[^:\/\/]`は`://`に関しては無視するよーと言う正規表現の記法です。つまり、urlはそのままurlとして扱い、文字列入れ替えは行わないと言うことです。）`=”`に変えると言うことを意味してます。

次のパターンにいきましょう。

```
s/$/"/g
```

同じように読み解くと、
`$`、つまり行の終わりを見つけたら、`"`を付け加えよう！と言うことです。

最後のパターンですが、

```
s/ *=/=/g
```

これは、空白文字が`=`の前にあったらその空白を削除する、と言うことを意味しています。

苦手意識持っていたsedですが、一個一個見ていくと理解できますね。

そして最後に、awkを用いて、
```
VAR1="XXXXXXXXXX"
```
と言うsedの出力文字列に対して "export "と言う文字を付け加えてあげて、 `set_env.sh`に新規で書き込んであげることで完成です。

全体としては下記のようなコマンドになります。
```sh
sed -e 's/:[^:\/\/]/="/g;s/$/"/g;s/ *=/=/g' ./config/config.yml | awk '{print "export " $0 }' > set_env.sh
```




## 【Reference】
- [参照link](https://stackoverflow.com/questions/5014632/how-can-i-parse-a-yaml-file-from-a-linux-shell-script)








